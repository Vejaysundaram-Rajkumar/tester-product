<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Form</title>
    <style>
        /* General layout styling */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f4f4f9;
        }

        .form-container {
            width: 95vw;
            height: 95vh;
            display: flex;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin: 10px;
            overflow: hidden;
        }

        /* Left side (categories and metrics) */
        .left-side {
            flex: 2;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            justify-items: center;
            background-color: #f0f4f7;
            padding: 10px;
        }

        .category-box {
            background-color: #e0f7fa;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        .category-box:hover {
            background-color: #b2ebf2;
        }

        /* Metrics Section (Bottom Left) */
        .metrics-container {
            margin-top: 20px;
            padding: 10px;
            background-color: #e3f2fd;
            height: 45vh;
            border-radius: 5px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            font-style: italic;
            text-align: center;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            width: 100%;
        }

        .goal-container {
            background-color: #e0f7fa;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        .goal-container:hover {
            background-color: #b2ebf2;
        }

        /* Right side (Selected metrics) */
        .right-side {
            flex: 1;
            background-color: #f0f4f7;
            padding: 10px;
            border-left: 2px solid #90caf9;
        }

        .selected-metrics-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .selected-metrics-list {
            list-style: none;
            padding: 0;
            overflow-y: auto;
        }

        .selected-metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #bbdefb;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: grab;
            user-select: none;
        }

        .selected-metric-item.dragging {
            opacity: 0.5;
        }

        .delete-btn {
            background-color: #ff5252;
            border: none;
            color: white;
            padding: 5px;
            border-radius: 50%;
            cursor: pointer;
        }

        .delete-btn:hover {
            background-color: #ff1744;
        }

        .submit-btn-container {
            margin-top: 20px;
            text-align: center;
        }

        .submit-btn {
            padding: 10px 20px;
            background-color: #90caf9;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .submit-btn.enabled {
            background-color: #1976d2;
            cursor: pointer;
            opacity: 1;
        }
    </style>
    <script>
        var selectedMetrics = [];
        var selectedMetricsCount = 0;
        var maxMetrics = 10;
        var draggingItem = null;

        function showMetrics(category) {
            const metricGrid = document.getElementById('metric-grid');
            const placeholderMessage = document.getElementById('placeholder-message');
            metricGrid.innerHTML = ''; // Clear existing metrics
            placeholderMessage.style.display = 'none'; // Hide placeholder message

            // Fetch the metrics for the selected category from a hidden data field (or passed via Flask)
            const metrics = document.getElementById(category + '_metrics').value.split(',');

            // Display metrics for the selected category
            metrics.forEach((metric) => {
                const metricElement = document.createElement('div');
                metricElement.classList.add('goal-container');
                metricElement.textContent = metric;
                metricElement.onclick = () => selectMetric(metric);
                metricGrid.appendChild(metricElement);
            });
        }

        function selectMetric(metric) {
            if (selectedMetricsCount >= maxMetrics) {
                alert("You can select a maximum of " + maxMetrics + " metrics.");
                return;
            }

            if (!selectedMetrics.includes(metric)) {
                selectedMetrics.push(metric);
                selectedMetricsCount++;
                addSelectedMetric(metric);
                updateSubmitButtonState();
            }
        }

        function addSelectedMetric(metric) {
            const selectedMetricsList = document.getElementById('selected-metrics-list');

            const metricItem = document.createElement('li');
            metricItem.classList.add('selected-metric-item');
            metricItem.draggable = true;
            metricItem.textContent = metric;

            const deleteBtn = document.createElement('button');
            deleteBtn.classList.add('delete-btn');
            deleteBtn.textContent = 'X';
            deleteBtn.onclick = () => removeMetric(metric, metricItem);

            metricItem.appendChild(deleteBtn);
            selectedMetricsList.appendChild(metricItem);

            // Add drag-and-drop functionality
            metricItem.addEventListener('dragstart', (e) => {
                draggingItem = metricItem;
                metricItem.classList.add('dragging');
            });

            metricItem.addEventListener('dragend', () => {
                draggingItem = null;
                metricItem.classList.remove('dragging');
            });

            selectedMetricsList.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(selectedMetricsList, e.clientY);
                if (afterElement == null) {
                    selectedMetricsList.appendChild(draggingItem);
                } else {
                    selectedMetricsList.insertBefore(draggingItem, afterElement);
                }
            });
        }

        function removeMetric(metric, metricItem) {
            metricItem.remove();
            selectedMetrics = selectedMetrics.filter(m => m !== metric);
            selectedMetricsCount--;
            updateSubmitButtonState();
        }

        function updateSubmitButtonState() {
            const submitButton = document.getElementById('submit-btn');
            if (selectedMetricsCount === maxMetrics) {
                submitButton.classList.add('enabled');
                submitButton.disabled = false;
            } else {
                submitButton.classList.remove('enabled');
                submitButton.disabled = true;
            }
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.selected-metric-item:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
    </script>
</head>
<body>
    <div class="form-container">
        <!-- Left Side: Categories and Metrics -->
        <div class="left-side">
            <div class="categories-grid">
                <!-- Dynamically Generated Categories -->
                {% for category, metrics in categories_and_metrics.items() %}
                    <div class="category-box" onclick="showMetrics('{{ category }}')">
                        {{ category }}
                    </div>
                    <!-- Hidden input to hold metrics for each category -->
                    <input type="hidden" id="{{ category }}_metrics" value="{{ ','.join(metrics) }}">
                {% endfor %}
            </div>

            <div id="metrics-container" class="metrics-container">
                <!-- Placeholder message or dynamically loaded metrics -->
                <p id="placeholder-message">Here the metrics will be given according to the category that you select.</p>
                <div id="metric-grid" class="metric-grid"></div>
            </div>
        </div>

        <!-- Right Side: Selected Metrics -->
        <div class="right-side">
            <div class="selected-metrics-header">Selected Metrics</div>
            <ul id="selected-metrics-list" class="selected-metrics-list">
                <!-- Selected metrics with delete option -->
            </ul>

            <div class="submit-btn-container">
                <button id="submit-btn" class="submit-btn" disabled>Submit</button>
            </div>
        </div>
    </div>
</body>
</html>
